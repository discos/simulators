"""Some examples:

  $ discos-simulator start -s active_surface
  $ discos-simulator stop -s active_surface
  $ discos-simulator start -s if_distributor
  $ discos-simulator stop -s if_distributor
"""
import importlib
from argparse import ArgumentParser, ArgumentTypeError

from simulators.server import Simulator


def system_from_arg(system_name):
    try:
        return importlib.import_module('simulators.%s' % system_name)
    except ImportError:
        raise ArgumentTypeError('System "%s" unavailable.' % system_name)

parser = ArgumentParser()
parser.add_argument(
    '-s', '--system',
    type=system_from_arg,
    required=True,
    help='System name: active_surface, acu, ...',
)
parser.add_argument(
    '-t', '--type',
    required=False,
    help='System configuration type: IFD_14_channels for if_distributor, ...',
)
parser.add_argument(
    'action',
    choices=['start', 'stop']
)

args = parser.parse_args()

if args.type:
    try:
        systems = getattr(args.system, 'systems')
    except AttributeError:
        raise ArgumentTypeError(
            ('System %s has no configurations other than the default one. '
            % args.system.__name__.rsplit('.', 1)[1])
            + "Omit the '--type' flag to start the simulator properly."
        )
    if args.type not in systems:
        raise ArgumentTypeError(
            'Configuration %s for system %s not found.'
            % (args.type, args.system.__name__.rsplit('.', 1)[1])
        )
    args.system.system_type = args.type

simulator = Simulator(args.system)
if args.action == 'start':
    simulator.start()
elif args.action == 'stop':
    simulator.stop()
